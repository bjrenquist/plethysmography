Data Analysis Software
======================

This directory contains the software used to analyze data collected with the plethysmography system. The software was written using Python and is able to load RCALV datafiles generated by the data collection software. 

Briefly, it allows for automated or manual calibration from a voltage (pressure) signal to a chamber volume signal based on a set of calibration injections performed during data collection. It then computes the flow signal within the chamber. With complete volume and flow signals, the software can identify all individual breaths from the trace, while removing outliers including signal saturation and mouse movements. Important landmarks and breath characteristics are determined for each breath and reported along with 1-minute average statistics. This data is saved to an Excel file with a filename matching that of the collection datafile, along with an "analysis" tag.

Installation Instructions for Windows
-------------------------------------

1. Download the latest version of Python 3 from http://www.python.org (Python 3.10.1 as of 12/20/2021) and install it. Make sure to select the box to "Add Python to PATH" during the installation process to make it easier for your computer to locate the installed program. Once the installation finishes, there should be a "Setup was successful" confirmation window. You can ignore the option to "Disable path length limit."

2. Download the plethysmography project files from this github page (https://github.com/bjrenquist/plethysmography) by clicking the green "Code" button and selecting "Download ZIP". Right click and "Extract All" to unzip the downloaded folder and move it to the location of your choice (i.e. Desktop, Documents, etc.). Open this folder and navigate to the subfolder "plethysmography-main\data_analysis\respiratory_analysis_v1_5", which contains four Python (.py) files. Create a shortcut to the "respiration_analysis_v1-5.py" file and place the shortcut on your Desktop for quick access.

3. Install the Python modules that are required to run the respiration_analysis software. This step can be intimidating, but if you are careful and double check spelling at each step, it should go smoothly.

	a. Click on the Windows Start Menu icon and start typing "Command Prompt". Right click the option with the same name that Windows suggests, and select "Run as administrator". Allow changes to this system when the warning dialog appears.

	b. Check if Python is setup correctly. Type the following into the prompt and hit Enter:
		
		python --version

	  The current version of Python should be displayed if all is well (i.e. Python 3.10.1).

	c. Update Python's built-in module installer, pip. Enter the following at the command prompt:

		python -m pip install -U pip

	  This will update pip to the latest version available.

	d. Install the following modules by entering the following lines one at a time:

		pip install openpyxl

		pip install lxml

		pip install numpy

		pip install scipy

		pip install matplotlib

	  You should see a confirmation that each module was successfully installed.

4. Now that all the required modules are installed, you should be able to run the respiration_analysis
   program using the shortcut that you created in step 2. When you run it, two windows should open: a
   black Windows terminal and the Respiration Analysis window with Voltage and Pressure graphs. The
   Windows terminal can be largely ignored. If you run into a software bug during analysis, an error
   should be displayed in this window (useful for troubleshooting).

Installation Instructions for Mac OS X
--------------------------------------

1. Download the latest version of Python 3 from http://www.python.org (Python 3.10.1 as of 12/20/2021)
   and install it. The default install settings should be sufficient.

2. Download the plethysmography project files from this github page (https://github.com/bjrenquist/plethysmography) by clicking the green "Code" button and selecting "Download ZIP". Double click the zipped folder and it will automatically unzip/decrompress. Move the unzipped folder to the location of your choice (i.e. Desktop, Documents, etc.). Open this folder and navigate to the subfolder "plethysmography-main/data_analysis/respiratory_analysis_v1_5", which contains four Python (.py) files.

3. Install the Python modules that are required to run the respiration_analysis software. This step can
   be intimidating, but if you are careful and double check spelling at each step, it should go smoothly.

	a. In the Finder, open the /Applications/Utilities folder and run Terminal.

	b. Check if Python is setup correctly. Type the following into the prompt and hit Return:
		
		python3 --version

	  The current version of Python should be displayed if all is well (i.e. Python 3.10.1).

	c. Update Python's built-in module installer, pip3. Enter the following at the command prompt:

		pip3 install --upgrade pip

	  This will update pip3 to the latest version available.

	d. Install the following modules by entering the following lines one at a time:

		pip3 install openpyxl

		pip3 install lxml

		pip3 install numpy

		pip3 install scipy

		pip3 install matplotlib

	  You should see a confirmation that each module was successfully installed.

4. Now that all the required modules are installed, you should be able to run the respiration_analysis
   program. To do this, create a small text file with a one-line Terminal command that you can
   copy and paste into the Terminal window. You will need to figure out the exact filepath to the
   "respiratory_analysis_v1_5.py" file. The easiest way to do this is to have the Terminal window and the
   unzipped folder from step 2 opened side-by-side. If you drag the file into the Terminal window, it will
   show the full filepath. It should look similar to this:
       
        /Users/Username/Desktop/plethysmography-main/data_analysis/respiratory_analysis_v1_5/respiratory_analysis_v1_5.py

   Open a text editor and copy/paste this filepath onto the first line. Now, add "python3 " (with a space)
   before the filename so the line looks like this:
        
        python3 /Users/Username/Desktop/plethysmography-main/data_analysis/respiratory_analysis_v1_5/respiratory_analysis_v1_5.py

   Save the text file and put it on your Desktop for convenience. To run the analysis software, you will
   open a Terminal window, open this text file, copy/paste the whole line into the Terminal window, then 
   press Return. 

   Two windows should open: a blank terminal and the Respiration Analysis window with Voltage and Pressure 
   graphs. The terminal can be largely ignored. If you run into a software bug during analysis, an error
   should be displayed in this window (screenshots of this are useful for fixing the bug).
   
Operation
---------
Upon opening the data analysis software, you will see the Respiration Analysis window two blank graphs. The process for analyzing a breathing datafile is all contained within the File, Edit, Analysis, and View menus at the top of the window. For ease of use, only the options useful to the currently displayed data will be accessible, and all other options will be grayed out. 

Please note that the software is not currently robust enough to switch between datafiles during the same analysis session, or to undo any steps taken. The original datafile will never be altered by this software, so don't worry if you make a mistake. If you need to restart an analysis or open a different datafile, you must close and restart the software. 

The main steps for completing a full analysis are as follows:

1. In the File menu, click Open... and select the RCALV file you want to analyze. The software will load the datafile and display the raw voltage data from the pressure transducer on the top graph. It will automatically convert this voltage signal to a pressure signal using the pressure transducer's transfer function. Note that you can use the X Position slider bar below the two graphs to scroll through the full data set.

2. In the Analysis menu, you now have the option to automatically or manually calibrate the pressure signal into a volume signal based on calibration injections made during data collection. You can also load calibration data from another datafile instead. These options are described below:
   
	a. Automatic Volume Calibration. If you select Start Automatic Volume Calibration, you will first be prompted if you want to use calibration data from another file. Click No. The software will then automatically identify calibration injections and create a linear regression of pressure change versus known volume changes. Any points identified as outliers are plotted in red and excluded from the regression. If the results look good, select Yes to finish and save the volume calibration.
   
	b. Manual Volume Calibration. If you select Start Manual Volume Calibration, you will first be prompted if you want to use calibration data from another file. Click No. A red line representing the smoothed pressure signal will be displayed. Scroll to the first calibration injection, which should be indicated with a number and an arrow if you used the event logger in the data collection software. Near the calibration injection, the red line should ideally have a flat baseline segment to the left followed by a step up to a flat calibration segment on the right. You will use the mouse to identify the start and end positions of each flat segment in order from left to right; a red X will appear after each click. Once the four points have been selected, you will be prompted for the known injection volume in milliliters. The software will compute the pressure change between the plateaus and plot a point on the top graph. Repeat this process for each calibration injection, skipping any injections where the breathing signal is noisy. During this process, you may click on any of the plotted points in the top graph to remove it. When you have plotted each point, in the Analysis menu, click Stop Manual Volume Calibration and select Yes when prompted to finish and save the volume calibration.
   
	c. Use Calibration Data from Another File. If you select either calibration method from the Analysis menu, you will be prompted to use calibration data from another file. Click Yes. You will now be prompted to select the datafile containing the calibration data you want to use. Note that you must select an Excel file from a previous data analysis session, otherwise you will get an error. This method should only be used if the mouse remained in the sealed chamber for multiple data collection sessions. For example, you may put a mouse in the chamber, collect one datafile with all of the calibration injections, and then start another datafile for additional breathing measurements. The calibration data from the first datafile should hold true for the second datafile if the chamber remained sealed between measurements.
   
	Regardless of the calibration method used, the software will use the regression to convert the pressure signal to a change in chamber volume signal and plot this on the top graph. Then a flow signal will be approximated from the volume signal and plotted on the bottom graph.

3. In the Analysis menu, click Find Breath Landmarks. You will be prompted for a start and stop time window for the search; you can use this window to exclude initial calibration data or extraneous data at the end of the datafile. The software will identify individual breaths and highlight them as follows. Inspiration segments will be colored blue, expiration segments will be colored green, and pause segments will be colored red. Peaks and troughs for both volume and flow are identified with black triangles. The software will automatically exclude breaths where the signal is noisy due to mouse movements, where the signal saturates or exceeds the working range of the pressure transducer, or where a breath is a statistical outlier compared to neighboring breaths.

4. The software now has all of the information needed to report breathing statistics. In the File menu, click Save As... to export the analysis to an Excel file. By default, the new filename will be the same as that of the RCALV datafile, appended with "analysis". You will receive a final prompt confirming that the new analysis file has been saved successfully. You can now close the analysis software.

5. Edit Menu. This menu contains all of the adjustable settings for the software. A separate readme file will be posted containing details on making adjustments to these settings.

6. View Menu. This menu lets you adjust the axis scales for the currently displayed graphs. Specifically, the Adjust Time Axis Scale option is very useful: when you want to see individual breaths more clearly, decrease the "Seconds to Show" value; or if you are doing a manual volume calibration and you just want to see the general shape of the breathing signal, increase the "Seconds to Show" value. The Go To Time... option is a great way to jump to a specific timepoint within your data instead of using the scrollbar.
